---
title: "Supplemental Results"
author: "Daniel Reyes"
date: "7/21/2021"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  word_document:
    toc: yes
  html_document:
    css: mystyle.css
    toc: yes
    df_print: paged
bibliography: references.bib
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE)
source("00_packages_v1.R", local = knitr::knit_global())
source("01_diagnostic function_v1.R", local = knitr::knit_global())
source("02_Trait transformations and data prep_v1.R", local = knitr::knit_global())
source("04_Models per trait_v1.R", local = knitr::knit_global())
```

# Suplementary results

The purpose of this supplementary material is to show the process of model selection, data transformation and model diagnostics for the univariate models. We show the measured traits mentioned in the main text. But also include some other traits that we measured, but were difficult to converge such as: Longest spine, defined as the length of a complete upper spine (mm). Upper spines, defined as the presence or absence of upper spines. We did not use these traits because not all our datasets included these measurements. Spine length was only measured on the natural populations but not on herbarium samples. Upper spines had difficulty converging with our models.

We tested each model trait using the untransformed, log-transformed, and square-root-transformed data. Then used the *testsResiduals* function from the package *DHARMa* to check for model convergence. Here we show the outputs of the selected transformations using the functions *plotQQunif* for the QQ plots, and *plotResiduals* for the residuals histogram.

# Phenotypic divergence between mainland and island habitats

## Mericarps

### Length

```{r mericarp length untrasformed, echo=FALSE, fig.align='left', fig.cap= "Mericarp length untransformed data."}
# Diagnostics with DHARMA
par(mfrow = c(1, 3))
DHARMa::plotQQunif(meri_length_m1)
DHARMa::plotResiduals(meri_length_m1)
hist(resid(meri_length_m1), breaks = 20)
#testResiduals(meri_length_m1)
```

\newpage

### Width

The square-root transformation was the best converged data for our model.

```{r mericarp width square-root transformed data, echo=FALSE, fig.align='left', fig.cap= "Mericarp width square-root transformed data."}
# testResiduals(meri_width_m3)
par(mfrow = c(1, 3))
DHARMa::plotQQunif(meri_width_m3)
DHARMa::plotResiduals(meri_width_m3)
hist(resid(meri_width_m3), breaks = 20)
```

\newpage

### Depth

For depth, the untransformed data converged the best. The residuals were more normally distributed than the other transformations, that showed a slight skew to the right.

```{r mericarp depth untransformed data, echo=FALSE, fig.align='left', fig.cap= "Mericarp depth untransformed data."}
# testResiduals(meri_depth_m1)
par(mfrow = c(1, 3))
DHARMa::plotQQunif(meri_depth_m1)
DHARMa::plotResiduals(meri_depth_m1)
hist(resid(meri_depth_m1), breaks = 20)
```

\newpage

### Spine length

Spine length measures the length of the upper spine. Some mericarps, mainly from the Galapagos lack upper spines. We tested the dataset including these mericarps first, then evaluating the model convergence after removing these mericarps. As these mericarps were considered outliers in our evaluations.
We  did not include this trait because it was not measured for all datasets. Here we show the distribution and diagnostics of this trait when the mericarps without uppers spines were included.

```{r spine length raw data, fig.align='left', echo=F, fig.cap= "Histogram of mericarp spine length, showing the mericarps that lack upper spines (scored 0)."}

hist(meri_spine_length$spine_length, breaks = 20)

```

\newpage

```{r mericarp spine length untransformed data, echo=FALSE, fig.align='left', fig.cap= "Mericarp spine length untransformed data. Notice the output for the outlier test when we include the mericarps without spines."}
testResiduals(meri_spine_length_m1)
# par(mfrow = c(1, 3))
# DHARMa::plotQQunif(meri_spine_length_m1)
# DHARMa::plotResiduals(meri_spine_length_m1)
# hist(resid(meri_spine_length_m1), breaks = 20)
```

\newpage

When the mericarps without spines were removed from the dataset this is how the models diagnostics looks like.

```{r, spine length without zero, echo=F, fig.align='left', fig.cap="Histogram of mericarp spine lengt with only mericarps that had upper spines present,"}

hist(meri_spine_length_wozero$spine_length, breaks = 20)

```

\newpage

```{r mericarp spine length without zero untransformed data, echo=FALSE, fig.align='left', fig.cap= "Mericarp spine length without zero, untransformed. Notice the outlier test when we removed the mericarps without spines."}
testResiduals(meri_spine_length_wozero_m1)
# par(mfrow = c(1, 3))
# DHARMa::plotQQunif(meri_spine_length_wozero_m1)
# DHARMa::plotResiduals(meri_spine_length_wozero_m1)
# hist(resid(meri_spine_length_wozero_m1), breaks = 20)
```

  The models did not converge even after removing the mericarps without upper spines. However, the distribution of residuals was less skewed after removing them. We used the square-root transformed data to run compare between mainland and island groups, and we found that spine length on islands were 2% longer than on the mainland, a difference that was not statistically significant ($X^2$ = 1.70, p = 0.1913). 

\newpage

### Tip distance

  Similar to spine length the number of mericarps that lacked upper spines influenced our model evaluations. Here we show the diagnostics of model convergence for tip distance with those mericarps and with those mericarps removed.

```{r, tip distance, echo=F, fig.align='left', fig.cap="Histogram of mericarp tip distance. Notice the distribution of mericarps without spines."}

hist(meri_tip_distance$tip_distance, breaks = 20)

```

```{r mericarp tip distance untransformed data, echo=FALSE, fig.align='left', fig.cap= "Mericarp tip distance untransformed data. Notice the output for the outlier test when we include the mericarps without spines."}
testResiduals(meri_tip_distance_m1)
# par(mfrow = c(1, 3))
# DHARMa::plotQQunif(meri_tip_distance_m1)
# DHARMa::plotResiduals(meri_tip_distance_m1)
# hist(resid(meri_tip_distance_m1), breaks = 20)
```

\newpage

  As observed, there was an effect of these mericarps without upper spines in our model. So we decided to remove them from analysis (n = 158).We tested the dataset with these mericarps removed and found that the residual distribution was also skewed. After observing this skewed distribution we decided to filter out the individuals with residuals less than -5 and greater than 5. Then, run the model evaluations again.
  
```{r, tip distance witout zero, echo=F, fig.align='left', fig.cap="Histogram of mericarp tip distance with mericarps that lacked upper spines removed"}
hist(meri_tip_distance_wozero$tip_distance, breaks = 20)
```
  
```{r mericarp tip distance zero removed residuals data, echo=FALSE, fig.align='left', fig.cap= "Mericarp tip distance residual distribution, after removing mericarps without spines. Notice the skew on the left side of the distribution. Plot on the right shows the distribution of residuals after removing individuals less than -5 and greater than 5."}
# testResiduals(meri_tip_distance_m3)
 par(mfrow = c(1, 2))
hist(resid(meri_tip_distance_m4), breaks = 20)
hist(meri_tip_distance_wozero_filter$residuals, breaks = 20)

```

```{r mericarp tip distance filter without zero, echo=FALSE, fig.align='left', fig.cap="Model evaluations after removing residuals."}
# testResiduals(meri_tip_distance_m7)
 par(mfrow = c(1, 3))
 DHARMa::plotQQunif(meri_tip_distance_m7)
 DHARMa::plotResiduals(meri_tip_distance_m7)
 hist(resid(meri_tip_distance_m7), breaks = 20)
```
